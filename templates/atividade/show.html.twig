{% extends 'base.html.twig' %}

{% block title %}Atividade {{ atividade.idExterno }}{% endblock %}

{% block body %}
<h1 class="page-title">Atividade {{ atividade.idExterno }}</h1>
<div class="activity-sections">
<div class="card activity-section">
    <div class="actions mb-2">
        <a class="btn secondary" href="{{ path('app_atividade_edit', {id: atividade.id}) }}">Editar Atividade</a>
        <form method="post" action="{{ path('app_atividade_delete', {id: atividade.id}) }}" data-confirm-title="Confirmação" data-confirm-message="Excluir atividade e todos os registros relacionados?" data-confirm-confirm-text="Excluir">
            <input type="hidden" name="_token" value="{{ csrf_token('delete_atividade_' ~ atividade.id) }}">
            <button class="btn danger" type="submit">Excluir Atividade</button>
        </form>
    </div>
    <div class="subtle">Projeto</div>
    <div><strong>{{ atividade.projeto.nome }}</strong></div>
    <div class="subtle mt-2">Descrição</div>
    <div>{{ atividade.descricao }}</div>
</div>

<div class="card section-anchor activity-section" id="requests">
    <h2 class="section-title">SAP Requests</h2>
    {{ form_start(formRequest) }}
    <div class="grid-3">
        <div>{{ form_row(formRequest.tipo) }}</div>
        <div>{{ form_row(formRequest.numero) }}</div>
        <div>{{ form_row(formRequest.modulo) }}</div>
        <div>{{ form_row(formRequest.usuario) }}</div>
        <div>{{ form_row(formRequest.status) }}</div>
        <div>{{ form_row(formRequest.dataRequest) }}</div>
    </div>
    {{ form_row(formRequest.descricao) }}
    <div class="actions"><button class="btn success">Adicionar Request</button></div>
    {{ form_end(formRequest) }}

    <div class="table-wrap section-table">
        <table>
            <thead><tr><th>Tipo</th><th>Número</th><th>Descrição</th><th>Módulo</th><th>Usuário</th><th>Status</th><th>Data</th><th>Ações</th></tr></thead>
            <tbody>
            {% for req in atividade.requests %}
                <tr>
                    <td>{{ req.tipo }}</td>
                    <td>{{ req.numero }}</td>
                    <td>{{ req.descricao }}</td>
                    <td>{{ req.modulo }}</td>
                    <td>{{ req.usuario }}</td>
                    <td><span class="badge">{{ req.status }}</span></td>
                    <td>{{ req.dataRequest|date('d/m/Y') }}</td>
                    <td>
                        <div class="actions">
                            <a class="btn secondary icon-btn" title="Editar" aria-label="Editar" href="{{ path('app_request_edit', {id: req.id}) }}">
                                <svg class="icon" aria-hidden="true"><use href="#icon-edit"></use></svg>
                                <span class="sr-only">Editar</span>
                            </a>
                            <form method="post" action="{{ path('app_request_delete', {id: req.id}) }}" data-confirm-title="Confirmação" data-confirm-message="Excluir request?" data-confirm-confirm-text="Excluir">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete_request_' ~ req.id) }}">
                                <button class="btn danger icon-btn" type="submit" title="Excluir" aria-label="Excluir">
                                    <svg class="icon" aria-hidden="true"><use href="#icon-trash"></use></svg>
                                    <span class="sr-only">Excluir</span>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="8">Nenhuma request cadastrada.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="grid-2 section-grid activity-section">
    <div class="card section-card">
        <h2 class="section-title">Especificação Funcional</h2>
        {{ form_start(formFuncional, {attr: {enctype: 'multipart/form-data'}}) }}
        {{ form_widget(formFuncional.tipo) }}
        {{ form_row(formFuncional.arquivo) }}
        <div class="actions"><button class="btn">Enviar</button></div>
        {{ form_end(formFuncional) }}

        <div class="table-wrap section-table">
            <table>
                <thead><tr><th>Arquivo</th><th>Data</th><th>Ações</th></tr></thead>
                <tbody>
                {% for arq in atividade.arquivos|filter(a => a.tipo == 'FUNCIONAL') %}
                    <tr>
                        <td>{{ arq.nomeOriginal }}</td>
                        <td>{{ arq.criadoEm|date('d/m/Y H:i') }}</td>
                        <td>
                            <div class="actions nowrap">
                                <a class="btn secondary icon-btn" title="Download" aria-label="Download" href="{{ path('app_arquivo_download', {id: arq.id}) }}">
                                    <svg class="icon" aria-hidden="true"><use href="#icon-download"></use></svg>
                                    <span class="sr-only">Download</span>
                                </a>
                                <form method="post" action="{{ path('app_atividade_arquivo_delete', {atividade: atividade.id, arquivo: arq.id}) }}" data-confirm-title="Confirmação" data-confirm-message="Excluir este anexo funcional?" data-confirm-confirm-text="Excluir">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete_arquivo_' ~ arq.id) }}">
                                    <button class="btn danger icon-btn" type="submit" title="Excluir" aria-label="Excluir">
                                        <svg class="icon" aria-hidden="true"><use href="#icon-trash"></use></svg>
                                        <span class="sr-only">Excluir</span>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="3">Sem anexos funcionais.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card section-card">
        <h2 class="section-title">Especificação Técnica</h2>
        {{ form_start(formTecnica, {attr: {enctype: 'multipart/form-data'}}) }}
        {{ form_widget(formTecnica.tipo) }}
        {{ form_row(formTecnica.arquivo) }}
        <div class="actions"><button class="btn">Enviar</button></div>
        {{ form_end(formTecnica) }}

        <div class="table-wrap section-table">
            <table>
                <thead><tr><th>Arquivo</th><th>Data</th><th>Ações</th></tr></thead>
                <tbody>
                {% for arq in atividade.arquivos|filter(a => a.tipo == 'TECNICA') %}
                    <tr>
                        <td>{{ arq.nomeOriginal }}</td>
                        <td>{{ arq.criadoEm|date('d/m/Y H:i') }}</td>
                        <td>
                            <div class="actions nowrap">
                                <a class="btn secondary icon-btn" title="Download" aria-label="Download" href="{{ path('app_arquivo_download', {id: arq.id}) }}">
                                    <svg class="icon" aria-hidden="true"><use href="#icon-download"></use></svg>
                                    <span class="sr-only">Download</span>
                                </a>
                                <form method="post" action="{{ path('app_atividade_arquivo_delete', {atividade: atividade.id, arquivo: arq.id}) }}" data-confirm-title="Confirmação" data-confirm-message="Excluir este anexo técnico?" data-confirm-confirm-text="Excluir">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete_arquivo_' ~ arq.id) }}">
                                    <button class="btn danger icon-btn" type="submit" title="Excluir" aria-label="Excluir">
                                        <svg class="icon" aria-hidden="true"><use href="#icon-trash"></use></svg>
                                        <span class="sr-only">Excluir</span>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="3">Sem anexos técnicos.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card section-anchor activity-section" id="comentarios">
    <h2 class="section-title">Comentários da Situação Atual</h2>
    {{ form_start(formComentario) }}
    {{ form_widget(formComentario.texto) }}
    <div class="actions"><button class="btn">Adicionar Comentário</button></div>
    {{ form_end(formComentario) }}

    <div class="comment-list">
        {% for item in atividade.comentarios %}
            <div class="card">
                <div class="comment-item">
                    <div class="comment-content">
                        <div>{{ item.texto }}</div>
                        <div class="subtle">{{ item.criadoEm|date('d/m/Y H:i') }}</div>
                    </div>
                    <form class="comment-action" method="post" action="{{ path('app_atividade_comentario_delete', {atividade: atividade.id, comentario: item.id}) }}" data-confirm-title="Confirmação" data-confirm-message="Excluir este comentário?" data-confirm-confirm-text="Excluir">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete_comentario_' ~ item.id) }}">
                        <button class="btn danger icon-btn" type="submit" title="Excluir" aria-label="Excluir">
                            <svg class="icon" aria-hidden="true"><use href="#icon-trash"></use></svg>
                            <span class="sr-only">Excluir</span>
                        </button>
                    </form>
                </div>
            </div>
        {% else %}
            <div class="subtle">Nenhum comentário registrado.</div>
        {% endfor %}
    </div>
</div>
</div>
{% endblock %}
